<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kurikulum - Upload & Preview</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #00bcd4 100%);
            min-height: 100vh;
            padding-bottom: 50px;
        }
        .card {
            border: none;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border-radius: 15px;
        }
        .nav-link.active {
            background-color: #00bcd4 !important;
            color: white !important;
            border-radius: 15px 15px 0 0;
        }
        .table-hover tbody tr:hover {
            background-color: #e0f7fa;
            cursor: pointer;
        }
        .preview-iframe {
            height: 600px;
            width: 100%;
            border: 2px solid #00bcd4;
            border-radius: 8px;
        }
        .btn-primary {
            background-color: #00bcd4;
            border-color: #00bcd4;
        }
        .btn-primary:hover {
            background-color: #0097a7;
            border-color: #0097a7;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <h1 class="text-center mb-5" style="color: #004d40;">Sistem Pengelolaan Dokumen Kurikulum üéì</h1>
        <div class="card">
            <div class="card-header p-0 bg-white" style="border-radius: 15px 15px 0 0;">
                <ul class="nav nav-tabs border-0" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">üì§ Upload File</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab">üîç Preview Dokumen</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button" role="tab">‚öôÔ∏è Pengelolaan Data</button>
                    </li>
                </ul>
            </div>

            <div class="card-body">
                <div class="tab-content" id="myTabContent">

                    <!-- TAB 1: UPLOAD -->
                    <div class="tab-pane fade show active" id="upload" role="tabpanel">
                        <h5 class="card-title text-primary">Form Unggah Dokumen</h5>
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Pilih Tipe Dokumen</label><br>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="fileType" id="typeLedger" value="Ledger" required>
                                    <label class="form-check-label" for="typeLedger">Ledger</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="fileType" id="typeRapor" value="Rapor">
                                    <label class="form-check-label" for="typeRapor">Rapor</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="siswaSelect" class="form-label fw-bold">Pilih Nama Siswa</label>
                                <select class="form-select" id="siswaSelect" required>
                                    <option value="" disabled selected>Loading siswa...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="fileInput" class="form-label fw-bold">Pilih File PDF</label>
                                <input class="form-control" type="file" id="fileInput" accept=".pdf" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Upload File</button>
                            <div id="uploadMessage" class="mt-3"></div>
                        </form>
                    </div>

                    <!-- TAB 2: PREVIEW -->
                    <div class="tab-pane fade" id="preview" role="tabpanel">
                        <h5 class="card-title text-primary">Preview Dokumen Siswa Terbaru</h5>
                        <div class="row">
                            <div class="col-md-5">
                                <label for="previewSiswaSelect" class="form-label fw-bold">Pilih Siswa</label>
                                <select class="form-select mb-3" id="previewSiswaSelect">
                                    <option value="" disabled selected>Pilih Siswa...</option>
                                </select>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Pilih Dokumen</label><br>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="previewType" id="previewLedger" value="Ledger" checked>
                                        <label class="form-check-label" for="previewLedger">Ledger</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="previewType" id="previewRapor" value="Rapor">
                                        <label class="form-check-label" for="previewRapor">Rapor</label>
                                    </div>
                                </div>

                                <button class="btn btn-info w-100 text-white" onclick="loadPreview()">Tampilkan Preview</button>
                                <button id="downloadPrintBtn" class="btn btn-secondary w-100 mt-2" style="display:none;" onclick="openDownloadLink()">‚¨áÔ∏è Download / Print</button>
                                <div id="previewMessage" class="mt-3"></div>
                            </div>
                            <div class="col-md-7">
                                <p class="text-muted mt-3 mt-md-0">Area Preview:</p>
                                <iframe id="pdfPreviewFrame" class="preview-iframe" frameborder="0" allowfullscreen></iframe>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 3: MANAGE -->
                    <div class="tab-pane fade" id="manage" role="tabpanel">
                        <h5 class="card-title text-primary">Pengelolaan Data Siswa</h5>

                        <div class="card mb-4 p-3 bg-light border-0">
                            <h6 class="text-success">‚ûï Tambah Siswa Baru</h6>
                            <form id="addSiswaForm" class="row g-3">
                                <div class="col-md-5">
                                    <input type="text" class="form-control" id="addNamaSiswa" placeholder="Nama Siswa Lengkap" required>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="addKelas" placeholder="Kelas (contoh: X AKL)" required>
                                </div>
                                <div class="col-md-3">
                                    <button type="submit" class="btn btn-success w-100">Tambah</button>
                                </div>
                            </form>
                            <div id="addSiswaMessage" class="mt-3"></div>
                        </div>

                        <h6 class="text-danger">‚ûñ Hapus Data Siswa</h6>
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr class="table-primary">
                                    <th>#</th>
                                    <th>Nama Siswa</th>
                                    <th>Kelas</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="siswaTableBody">
                                <tr><td colspan="4" class="text-center">Memuat data siswa...</td></tr>
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // üî¥ GANTI URL INI DENGAN URL WEB APP ANDA (yang berakhiran /exec)
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwlMmLDdLrDgskZeJ1ozr1ZAPQ54yciMN6GrVi3JZP5jbVIMOOvvBzyEwWx9GPSPQfJvw/exec";

        let siswaData = [];
        let currentDownloadLink = '';

        // Fetch dengan error handling
        async function fetchData(url, options = {}) {
            try {
                console.log("Fetch:", url);
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const text = await response.text();
                console.log("Response:", text.substring(0, 300));
                
                const result = JSON.parse(text);
                
                if (!result.success) {
                    throw new Error(result.message || "Gagal");
                }
                
                return result;
                
            } catch (error) {
                console.error("Error:", error);
                return { 
                    success: false, 
                    message: error.message 
                };
            }
        }

        // Convert file ke Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Load siswa list
        async function loadSiswaList() {
            console.log("Loading siswa...");
            
            const url = `${APPS_SCRIPT_URL}?action=getSiswaList`;
            const result = await fetchData(url);
            
            const selectUpload = document.getElementById('siswaSelect');
            const selectPreview = document.getElementById('previewSiswaSelect');
            const tableBody = document.getElementById('siswaTableBody');
            
            selectUpload.innerHTML = '<option value="" disabled selected>Pilih Siswa...</option>';
            selectPreview.innerHTML = '<option value="" disabled selected>Pilih Siswa...</option>';
            tableBody.innerHTML = '';

            if (result.success) {
                siswaData = result.data;
                console.log("Loaded:", siswaData.length, "students");
                
                if (siswaData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada data siswa</td></tr>';
                    return;
                }

                siswaData.forEach((siswa, index) => {
                    const text = `${siswa.nama} (${siswa.kelas})`;

                    // Upload dropdown
                    const optUpload = new Option(text, siswa.folderId);
                    optUpload.setAttribute('data-siswa-name', siswa.nama);
                    
                    if (!siswa.folderId || siswa.folderId.trim() === "") {
                        optUpload.disabled = true;
                        optUpload.textContent += " ‚ö†Ô∏è Folder ID Kosong";
                    }
                    selectUpload.add(optUpload);

                    // Preview dropdown
                    selectPreview.add(new Option(text, siswa.folderId));

                    // Table
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = index + 1;
                    row.insertCell().textContent = siswa.nama;
                    row.insertCell().textContent = siswa.kelas;
                    
                    const cell = row.insertCell();
                    const btn = document.createElement('button');
                    btn.textContent = 'Hapus';
                    btn.className = 'btn btn-danger btn-sm';
                    btn.onclick = () => handleDelete(siswa.rowIndex, siswa.nama);
                    cell.appendChild(btn);
                });
                
            } else {
                selectUpload.innerHTML = `<option disabled>Error: ${result.message}</option>`;
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Error: ${result.message}</td></tr>`;
            }
        }

        // Upload file
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log("Upload submit");
            
            const msgDiv = document.getElementById('uploadMessage');
            msgDiv.innerHTML = '<div class="alert alert-info">‚è≥ Mengunggah...</div>';
            
            const fileInput = document.getElementById('fileInput');
            const siswaSelect = document.getElementById('siswaSelect');
            const option = siswaSelect.options[siswaSelect.selectedIndex];
            const radio = document.querySelector('input[name="fileType"]:checked');
            
            // Validasi
            if (!fileInput.files[0]) {
                msgDiv.innerHTML = '<div class="const file = fileInput.files[0];
        const folderId = option.value;
        const siswaName = option.getAttribute('data-siswa-name');
        const fileType = radio.value;
        
        console.log("File:", file.name, file.size, "bytes");
        console.log("Folder:", folderId);
        console.log("Siswa:", siswaName);
        console.log("Type:", fileType);
        
        try {
            const base64 = await fileToBase64(file);
            console.log("Base64 len:", base64.length);
            
            const payload = {
                action: 'uploadFile',
                folderId: folderId,
                siswaName: siswaName,
                fileType: fileType,
                fileData: base64
            };
            
            const result = await fetchData(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (result.success) {
                msgDiv.innerHTML = `<div class="alert alert-success">‚úÖ ${result.message}</div>`;
                document.getElementById('uploadForm').reset();
            } else {
                msgDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${result.message}</div>`;
            }
            
        } catch (error) {
            console.error(error);
            msgDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${error.message}</div>`;
        }
    });

    // Tambah siswa
    document.getElementById('addSiswaForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const msgDiv = document.getElementById('addSiswaMessage');
        msgDiv.innerHTML = '<div class="alert alert-info">Memproses...</div>';
        
        const nama = document.getElementById('addNamaSiswa').value.trim();
        const kelas = document.getElementById('addKelas').value.trim();
        
        const result = await fetchData(APPS_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'tambahSiswa', nama, kelas })
        });

        if (result.success) {
            msgDiv.innerHTML = `<div class="alert alert-success">‚úÖ ${result.message}</div>`;
            document.getElementById('addSiswaForm').reset();
            loadSiswaList();
        } else {
            msgDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${result.message}</div>`;
        }
    });

    // Hapus siswa
    async function handleDelete(rowIndex, nama) {
        if (!confirm(`Yakin hapus ${nama}?`)) return;
        
        const msgDiv = document.getElementById('addSiswaMessage');
        msgDiv.innerHTML = '<div class="alert alert-info">Menghapus...</div>';
        
        const result = await fetchData(APPS_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'hapusSiswa', rowIndex })
        });

        if (result.success) {
            msgDiv.innerHTML = `<div class="alert alert-success">‚úÖ ${result.message}</div>`;
            loadSiswaList();
        } else {
            msgDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${result.message}</div>`;
        }
    }

    // Preview
    async function loadPreview() {
        const folderId = document.getElementById('previewSiswaSelect').value;
        const fileType = document.querySelector('input[name="previewType"]:checked').value;
        const frame = document.getElementById('pdfPreviewFrame');
        const msgDiv = document.getElementById('previewMessage');
        const btn = document.getElementById('downloadPrintBtn');

        btn.style.display = 'none';
        currentDownloadLink = '';
        
        if (!folderId) {
            msgDiv.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Pilih siswa!</div>';
            frame.src = "";
            return;
        }
        
        msgDiv.innerHTML = '<div class="alert alert-info">üîç Mencari...</div>';
        frame.src = "";

        const url = `${APPS_SCRIPT_URL}?action=getPreviewLink&folderId=${encodeURIComponent(folderId)}&fileType=${encodeURIComponent(fileType)}`;
        const result = await fetchData(url);

        if (result.success) {
            frame.src = result.previewLink;
            currentDownloadLink = result.downloadLink;
            btn.style.display = 'block';
            msgDiv.innerHTML = `<div class="alert alert-success">‚úÖ File ${fileType} ditemukan</div>`;
        } else {
            frame.src = "";
            msgDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${result.message}</div>`;
        }
    }

    function openDownloadLink() {
        if (currentDownloadLink) {
            window.open(currentDownloadLink, '_blank');
        }
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        console.log("App started");
        console.log("URL:", APPS_SCRIPT_URL);
        loadSiswaList();
    });
</script>
</body>
</html>