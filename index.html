<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kurikulum - Upload & Preview</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Gradasi Warna Menarik */
        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #00bcd4 100%);
            min-height: 100vh;
            padding-bottom: 50px;
        }
        .card {
            border: none;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border-radius: 15px;
        }
        .nav-link.active {
            background-color: #00bcd4 !important;
            color: white !important;
            border-radius: 15px 15px 0 0;
        }
        .table-hover tbody tr:hover {
            background-color: #e0f7fa;
            cursor: pointer;
        }
        .preview-iframe {
            height: 600px;
            width: 100%;
            border: 2px solid #00bcd4;
            border-radius: 8px;
        }
        .btn-primary {
            background-color: #00bcd4;
            border-color: #00bcd4;
        }
        .btn-primary:hover {
            background-color: #0097a7;
            border-color: #0097a7;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <h1 class="text-center mb-5" style="color: #004d40;">Sistem Pengelolaan Dokumen Kurikulum üéì</h1>
        <div class="card">
            <div class="card-header p-0 bg-white" style="border-radius: 15px 15px 0 0;">
                <ul class="nav nav-tabs border-0" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">üì§ Upload File</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab">üîç Preview Dokumen</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button" role="tab">‚öôÔ∏è Pengelolaan Data</button>
                    </li>
                </ul>
            </div>

            <div class="card-body">
                <div class="tab-content" id="myTabContent">

                    <!-- TAB 1: UPLOAD FILE -->
                    <div class="tab-pane fade show active" id="upload" role="tabpanel">
                        <h5 class="card-title text-primary">Form Unggah Dokumen</h5>
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Pilih Tipe Dokumen</label><br>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="fileType" id="typeLedger" value="Ledger" required>
                                    <label class="form-check-label" for="typeLedger">Ledger</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="fileType" id="typeRapor" value="Rapor">
                                    <label class="form-check-label" for="typeRapor">Rapor</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="siswaSelect" class="form-label fw-bold">Pilih Nama Siswa</label>
                                <select class="form-select" id="siswaSelect" name="siswaSelect" required>
                                    <option value="" disabled selected>Loading siswa...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="fileInput" class="form-label fw-bold">Pilih File PDF</label>
                                <input class="form-control" type="file" id="fileInput" accept=".pdf" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Upload File</button>
                            <div id="uploadMessage" class="mt-3"></div>
                        </form>
                    </div>

                    <!-- TAB 2: PREVIEW DOKUMEN -->
                    <div class="tab-pane fade" id="preview" role="tabpanel">
                        <h5 class="card-title text-primary">Preview Dokumen Siswa Terbaru</h5>
                        <div class="row">
                            <div class="col-md-5">
                                <label for="previewSiswaSelect" class="form-label fw-bold">Pilih Siswa</label>
                                <select class="form-select mb-3" id="previewSiswaSelect">
                                    <option value="" disabled selected>Pilih Siswa...</option>
                                </select>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Pilih Dokumen</label><br>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="previewType" id="previewLedger" value="Ledger" checked>
                                        <label class="form-check-label" for="previewLedger">Ledger</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="previewType" id="previewRapor" value="Rapor">
                                        <label class="form-check-label" for="previewRapor">Rapor</label>
                                    </div>
                                </div>

                                <button class="btn btn-info w-100 text-white" onclick="loadPreview()">Tampilkan Preview</button>

                                <button id="downloadPrintBtn" class="btn btn-secondary w-100 mt-2" style="display:none;" onclick="openDownloadLink()">‚¨áÔ∏è Download / Print File</button>

                                <div id="previewMessage" class="mt-3"></div>
                            </div>
                            <div class="col-md-7">
                                <p class="text-muted mt-3 mt-md-0">Area Preview:</p>
                                <iframe id="pdfPreviewFrame" class="preview-iframe" frameborder="0" allowfullscreen></iframe>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 3: PENGELOLAAN DATA -->
                    <div class="tab-pane fade" id="manage" role="tabpanel">
                        <h5 class="card-title text-primary">Pengelolaan Data Siswa (Tambah/Hapus)</h5>

                        <div class="card mb-4 p-3 bg-light border-0">
                            <h6 class="text-success">‚ûï Tambah Siswa Baru</h6>
                            <form id="addSiswaForm" class="row g-3">
                                <div class="col-md-5">
                                    <input type="text" class="form-control" id="addNamaSiswa" placeholder="Nama Siswa Lengkap" required>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="addKelas" placeholder="Kelas (contoh: X AKL)" required>
                                </div>
                                <div class="col-md-3">
                                    <button type="submit" class="btn btn-success w-100">Tambah & Buat Folder</button>
                                </div>
                            </form>
                            <div id="addSiswaMessage" class="mt-3"></div>
                        </div>

                        <h6 class="text-danger">‚ûñ Hapus Data Siswa</h6>
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr class="table-primary">
                                    <th>#</th>
                                    <th>Nama Siswa</th>
                                    <th>Kelas</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="siswaTableBody">
                                <tr><td colspan="4" class="text-center">Memuat data siswa...</td></tr>
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // üî¥ PENTING: GANTI DENGAN URL WEB APP APPS SCRIPT ANDA
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzTOd5UcJ7TIQV0aHzORGoZENJXNXayPqvc-IdiG_E5RswGtQcMtSfj6-b3WtnnhlgZig/exec";

        let siswaData = [];
        let currentDownloadLink = '';

        // =================================================================
        // FUNGSI UTILITY
        // =================================================================

        /**
         * Fetch data dengan error handling yang lebih baik
         */
        async function fetchData(url, options = {}) {
            try {
                console.log("=== FETCH START ===");
                console.log("URL:", url);
                console.log("Options:", options);
                
                const response = await fetch(url, options);
                
                console.log("Response status:", response.status);
                console.log("Response ok:", response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                console.log("Response text (first 500 chars):", text.substring(0, 500));
                
                const result = JSON.parse(text);
                console.log("Parsed result:", result);
                
                if (!result.success) {
                    throw new Error(result.message || "Operasi gagal di server");
                }
                
                console.log("=== FETCH END (SUCCESS) ===");
                return result;
                
            } catch (error) {
                console.error("=== FETCH ERROR ===");
                console.error("Error:", error);
                return { 
                    success: false, 
                    message: `Error: ${error.message}` 
                };
            }
        }

        /**
         * Konversi File ke Base64
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Ambil hanya bagian Base64 (tanpa prefix data:application/pdf;base64,)
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // =================================================================
        // FUNGSI LOAD DATA SISWA
        // =================================================================

        /**
         * Load daftar siswa dari Google Sheet
         */
        async function loadSiswaList() {
            console.log("Loading siswa list...");
            
            const url = `${APPS_SCRIPT_URL}?action=getSiswaList`;
            const result = await fetchData(url);
            
            const selectUpload = document.getElementById('siswaSelect');
            const selectPreview = document.getElementById('previewSiswaSelect');
            const tableBody = document.getElementById('siswaTableBody');
            
            // Reset semua elemen
            selectUpload.innerHTML = '<option value="" disabled selected>Pilih Siswa...</option>';
            selectPreview.innerHTML = '<option value="" disabled selected>Pilih Siswa...</option>';
            tableBody.innerHTML = '';

            if (result.success) {
                siswaData = result.data;
                
                if (siswaData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada data siswa</td></tr>';
                    return;
                }

                siswaData.forEach((siswa, index) => {
                    const optionText = `${siswa.nama} (${siswa.kelas})`;

                    // Dropdown untuk Upload
                    const optUpload = new Option(optionText, siswa.folderId);
                    optUpload.setAttribute('data-siswa-name', siswa.nama);
                    
                    if (!siswa.folderId || siswa.folderId.trim() === "") {
                        optUpload.disabled = true;
                        optUpload.textContent += " ‚ö†Ô∏è Folder ID Kosong";
                    }
                    selectUpload.add(optUpload);

                    // Dropdown untuk Preview
                    const optPreview = new Option(optionText, siswa.folderId);
                    selectPreview.add(optPreview);

                    // Baris tabel untuk Pengelolaan Data
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = index + 1;
                    row.insertCell().textContent = siswa.nama;
                    row.insertCell().textContent = siswa.kelas;
                    
                    const actionCell = row.insertCell();
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Hapus';
                    deleteBtn.className = 'btn btn-danger btn-sm';
                    deleteBtn.onclick = () => handleDelete(siswa.rowIndex, siswa.nama);
                    actionCell.appendChild(deleteBtn);
                });
                
                console.log("Siswa list loaded successfully:", siswaData.length, "students");
                
            } else {
                selectUpload.innerHTML = `<option disabled>Error: ${result.message}</option>`;
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Error: ${result.message}</td></tr>`;
            }
        }

        // =================================================================
        // FUNGSI UPLOAD FILE
        // =================================================================

        /**
         * Handle submit form upload file
         */
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log("=== UPLOAD FORM SUBMIT ===");
            
            const messageDiv = document.getElementById('uploadMessage');
            messageDiv.innerHTML = '<div class="alert alert-info">‚è≥ Mengunggah file... Mohon tunggu.</div>';
            
            // Ambil data form
            const fileInput = document.getElementById('fileInput');
            const siswaSelect = document.getElementById('siswaSelect');
            const selectedOption = siswaSelect.options[siswaSelect.selectedIndex];
            const fileTypeRadio = document.querySelector('input[name="fileType"]:checked');
            
            // Validasi lengkap
            if (!fileInput.files[0]) {
                messageDiv.innerHTML = '<div class="alert alert-danger">‚ùå Pilih file PDF terlebih dahulu!</div>';
                return;
            }
            
            if (!selectedOption || selectedOption.disabled || !selectedOption.value) {
                messageDiv.innerHTML = '<div class="alert alert-danger">‚ùå Pilih siswa yang valid (pastikan Folder ID tidak kosong)!</div>';
                return;
            }
            
            if (!fileTypeRadio) {
                messageDiv.innerHTML = '<div class="alert alert-danger">‚ùå Pilih tipe dokumen (Ledger/Rapor)!</div>';
                return;
            }
            
            const file = fileInput.files[0];
            const folderId = selectedOption.value;
            const siswaName = selectedOption.getAttribute('data-siswa-name');
            const fileType = fileTypeRadio.value;
            
            console.log("Upload Info:");
            console.log("- File name:", file.name);
            console.log("- File size:", file.size, "bytes");
            console.log("- File type:", file.type);
            console.log("- Folder ID:", folderId);
            console.log("- Siswa:", siswaName);
            console.log("- Doc Type:", fileType);
            
            // Konver// Kirim sebagai JSON POST
            const payload = {
                action: 'uploadFile',
                folderId: folderId,
                siswaName: siswaName,
                fileType: fileType,
                fileName: file.name,
                fileData: base64Data,
                mimeType: file.type
            };
            
            console.log("Sending payload to server...");
            
            const result = await fetchData(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (result.success) {
                messageDiv.innerHTML = `<div class="alert alert-success">‚úÖ ${result.message}</div>`;
                document.getElementById('uploadForm').reset();
                console.log("Upload successful!");
            } else {
                messageDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${result.message}</div>`;
                console.error("Upload failed:", result.message);
            }
            
        } catch (error) {
            console.error("Upload error:", error);
            messageDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
        }
    });

    // =================================================================
    // FUNGSI TAMBAH SISWA
    // =================================================================

    /**
     * Handle submit form tambah siswa
     */
    document.getElementById('addSiswaForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        console.log("=== ADD SISWA FORM SUBMIT ===");
        
        const messageDiv = document.getElementById('addSiswaMessage');
        messageDiv.innerHTML = '<div class="alert alert-info">Memproses...</div>';
        
        const nama = document.getElementById('addNamaSiswa').value.trim();
        const kelas = document.getElementById('addKelas').value.trim();
        
        console.log("Add Siswa - Nama:", nama, "Kelas:", kelas);
        
        const result = await fetchData(APPS_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'tambahSiswa', nama, kelas })
        });

        if (result.success) {
            messageDiv.innerHTML = `<div class="alert alert-success">‚úÖ ${result.message}</div>`;
            document.getElementById('addSiswaForm').reset();
            loadSiswaList(); // Refresh list
            console.log("Siswa added successfully");
        } else {
            messageDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${result.message}</div>`;
            console.error("Add siswa failed:", result.message);
        }
    });

    // =================================================================
    // FUNGSI HAPUS SISWA
    // =================================================================

    /**
     * Handle delete siswa
     */
    async function handleDelete(rowIndex, namaSiswa) {
        if (!confirm(`Yakin ingin menghapus data siswa "${namaSiswa}"?\n\nCatatan: File di Google Drive tidak akan terhapus otomatis, hanya data di Sheet.`)) {
            return;
        }
        
        console.log("=== DELETE SISWA ===");
        console.log("Row:", rowIndex, "Nama:", namaSiswa);
        
        const messageDiv = document.getElementById('addSiswaMessage');
        messageDiv.innerHTML = '<div class="alert alert-info">Menghapus...</div>';
        
        const result = await fetchData(APPS_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'hapusSiswa', rowIndex })
        });

        if (result.success) {
            messageDiv.innerHTML = `<div class="alert alert-success">‚úÖ ${result.message}</div>`;
            loadSiswaList(); // Refresh list
            console.log("Siswa deleted successfully");
        } else {
            messageDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${result.message}</div>`;
            console.error("Delete siswa failed:", result.message);
        }
    }

    // =================================================================
    // FUNGSI PREVIEW FILE
    // =================================================================

    /**
     * Load preview file PDF
     */
    async function loadPreview() {
        console.log("=== LOAD PREVIEW ===");
        
        const folderId = document.getElementById('previewSiswaSelect').value;
        const fileType = document.querySelector('input[name="previewType"]:checked').value;
        const previewFrame = document.getElementById('pdfPreviewFrame');
        const messageDiv = document.getElementById('previewMessage');
        const downloadBtn = document.getElementById('downloadPrintBtn');

        downloadBtn.style.display = 'none';
        currentDownloadLink = '';
        
        if (!folderId) {
            messageDiv.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Pilih siswa terlebih dahulu!</div>';
            previewFrame.src = "";
            return;
        }
        
        console.log("Loading preview - Folder ID:", folderId, "Type:", fileType);
        
        messageDiv.innerHTML = '<div class="alert alert-info">üîç Mencari file PDF terbaru...</div>';
        previewFrame.src = "";

        const url = `${APPS_SCRIPT_URL}?action=getPreviewLink&folderId=${encodeURIComponent(folderId)}&fileType=${encodeURIComponent(fileType)}`;
        const result = await fetchData(url);

        if (result.success) {
            previewFrame.src = result.previewLink;
            currentDownloadLink = result.downloadLink;
            downloadBtn.style.display = 'block';
            messageDiv.innerHTML = `<div class="alert alert-success">‚úÖ File ${fileType} ditemukan dan ditampilkan</div>`;
            console.log("Preview loaded successfully");
        } else {
            previewFrame.src = "";
            messageDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${result.message}</div>`;
            console.error("Preview failed:", result.message);
        }
    }

    /**
     * Open download link
     */
    function openDownloadLink() {
        if (currentDownloadLink) {
            console.log("Opening download link:", currentDownloadLink);
            window.open(currentDownloadLink, '_blank');
        } else {
            document.getElementById('previewMessage').innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Tidak ada link unduh tersedia</div>';
        }
    }

    // =================================================================
    // INISIALISASI
    // =================================================================

    document.addEventListener('DOMContentLoaded', () => {
        console.log("=== APP INITIALIZED ===");
        console.log("Apps Script URL:", APPS_SCRIPT_URL);
        
        if (APPS_SCRIPT_URL.includes("AKfycbzkfOy41f2Vzvd2nwe5WE3g_GMUADRd5SClGVxt-9mitcVjE8VYI4pBJxzzW8ZG7lkBkw")) {
            console.warn("‚ö†Ô∏è WARNING: Masih menggunakan URL default! Ganti dengan URL Web App Anda.");
        }
        
        loadSiswaList();
    });
</script>