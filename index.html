<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container-fluid {
            max-width: 1200px;
            margin-top: 20px;
        }

        .card {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }

        #previewFrame {
            width: 100%;
            height: 600px;
            border: 1px solid #dee2e6;
            margin-top: 15px;
            border-radius: 4px;
        }

        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }

        .table-scroll {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <h3 class="mb-4 text-center text-primary">Pusat Data Ledger & Rapor Siswa</h3>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title m-0">Data Siswa</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSiswaModal">
                            <i class="fas fa-plus-circle me-1"></i> Tambah Siswa
                        </button>
                    </div>

                    <div id="siswaListTableContainer" class="table-scroll">
                        <table class="table table-striped table-hover table-sm" id="siswaTable">
                            <thead class="sticky-top bg-light">
                                <tr>
                                    <th>#</th>
                                    <th>NIS</th>
                                    <th>Nama Siswa</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="siswaTableBody">
                                <tr><td colspan="4" class="text-center">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card p-3 h-100">
                    <h5 class="card-title text-info">Pilih dan Pratinjau</h5>
                    <div class="mb-3">
                        <label for="siswaSelect" class="form-label">Siswa Terpilih:</label>
                        <select class="form-select" id="siswaSelect" onchange="handleSiswaChange()">
                            <option value="" data-folder-id="">--- Pilih Siswa ---</option>
                        </select>
                        <small id="folderIdDisplay" class="form-text text-muted"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Pilih Tipe File:</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="fileTypeRadio" id="radioLedger" value="LEDGER" checked onchange="handleSiswaChange()">
                                <label class="form-check-label" for="radioLedger">LEDGER</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="fileTypeRadio" id="radioRapor" value="RAPOR" onchange="handleSiswaChange()">
                                <label class="form-check-label" for="radioRapor">RAPOR</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-auto">
                        <h6 class="m-0">Pratinjau File:</h6>
                        <a href="#" id="downloadPrintBtn" class="btn btn-outline-secondary btn-sm" style="display: none;" target="_blank">
                            <i class="fas fa-download me-1"></i> Download/Print
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card p-3 border-success h-100">
                    <h5 class="card-title text-success">Upload File PDF</h5>
                    <div class="row g-3 align-items-end">
                        <div class="col-md-8">
                            <label for="fileInput" class="form-label">Pilih File PDF Ledger/Rapor:</label>
                            <input class="form-control" type="file" id="fileInput" accept=".pdf" required>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" id="uploadBtn" onclick="uploadFile()">
                                <span id="uploadSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                                Upload
                            </button>
                        </div>
                    </div>
                    <div id="uploadMessageArea" class="mt-3"></div>
                </div>
            </div>
        </div>
        
        <div class="card p-3 mb-4">
            <div id="previewMessageArea" class="mb-2"></div>
            <iframe id="previewFrame" title="Pratinjau File"></iframe>
        </div>


    </div>
    
    <div class="modal fade" id="addSiswaModal" tabindex="-1" aria-labelledby="addSiswaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSiswaModalLabel">Tambah Data Siswa Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newNis" class="form-label">NIS (Nomor Induk Siswa)</label>
                        <input type="text" class="form-control" id="newNis" required>
                    </div>
                    <div class="mb-3">
                        <label for="newName" class="form-label">Nama Siswa</label>
                        <input type="text" class="form-control" id="newName" required>
                    </div>
                    <div id="modalMessageArea" class="mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" id="saveSiswaBtn" onclick="tambahSiswa()">
                        <span id="addSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                        Simpan Siswa
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ðŸ”´ PENTING: GANTI DENGAN URL WEB APP APPS SCRIPT ANDA YANG SUDAH DIOTORISASI (berakhir /exec)
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMqu9MYzWpT72yZz37kDtuwX5J3wfsTFad-sS13de6ZK86lmoQlgkFTv4nYYaiyUy1Qg/exec"; 
        
        let currentFolderId = null;
        let currentSiswaName = null;
        let siswaData = []; // Menyimpan semua data siswa
        let isLoading = false;

        document.addEventListener('DOMContentLoaded', loadSiswaList);

        // =================================================================
        // UTILITY FUNCTIONS (Client-Side)
        // =================================================================

        async function fetchData(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Fetch Error:', error);
                return {
                    success: false,
                    message: `Koneksi gagal: ${error.message}`
                };
            }
        }

        function showMessage(type, message, targetId = 'uploadMessageArea') {
            const messageDiv = document.getElementById(targetId);
            messageDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
        }
        
        function setLoading(loading, btnId = 'uploadBtn', spinnerId = 'uploadSpinner', text = 'Upload') {
            isLoading = loading;
            const btn = document.getElementById(btnId);
            const spinner = document.getElementById(spinnerId);
            btn.disabled = loading;
            spinner.classList.toggle('d-none', !loading);
            btn.innerHTML = loading ? `<span id="${spinnerId}" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> ${text}...` : `<i class="fas fa-upload me-1"></i> ${text}`;
        }
        
        // =================================================================
        // LOAD & RENDER SISWA
        // =================================================================

        async function loadSiswaList() {
            const siswaSelect = document.getElementById('siswaSelect');
            const tableBody = document.getElementById('siswaTableBody');
            
            siswaSelect.innerHTML = '<option value="" data-folder-id="">--- Memuat Data Siswa... ---</option>';
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center"><i class="fas fa-sync fa-spin me-2"></i>Memuat data...</td></tr>';
            
            const url = `${APPS_SCRIPT_URL}?action=getSiswaList`;
            const result = await fetchData(url);
            
            if (result.success && Array.isArray(result.data)) {
                siswaData = result.data;
                renderSiswaDropdown();
                renderSiswaTable();
                showMessage('info', `Total ${siswaData.length} siswa dimuat.`, 'previewMessageArea');
            } else {
                siswaSelect.innerHTML = `<option value="" disabled>${result.message || 'Gagal memuat data siswa.'}</option>`;
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">${result.message || 'Gagal memuat data siswa. Cek Sheet ID dan Deployment.'}</td></tr>`;
                showMessage('danger', result.message || 'Gagal memuat data siswa.', 'previewMessageArea');
            }
        }
        
        function renderSiswaDropdown() {
            const siswaSelect = document.getElementById('siswaSelect');
            siswaSelect.innerHTML = '<option value="" data-folder-id="">--- Pilih Siswa ---</option>';
            
            siswaData.forEach(siswa => {
                const option = document.createElement('option');
                option.value = siswa.name;
                option.textContent = `${siswa.name} (NIS: ${siswa.nis})`;
                option.setAttribute('data-folder-id', siswa.folderId);
                option.setAttribute('data-row-index', siswa.rowIndex);
                siswaSelect.appendChild(option);
            });
        }
        
        function renderSiswaTable() {
            const tableBody = document.getElementById('siswaTableBody');
            tableBody.innerHTML = '';
            
            if (siswaData.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Belum ada data siswa.</td></tr>';
                 return;
            }
            
            siswaData.forEach((siswa, index) => {
                const row = tableBody.insertRow();
                row.setAttribute('data-row-index', siswa.rowIndex);
                
                row.insertCell().textContent = index + 1;
                row.insertCell().textContent = siswa.nis;
                row.insertCell().textContent = siswa.name;
                
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="btn btn-outline-danger btn-sm" onclick="confirmHapusSiswa('${siswa.name}', ${siswa.rowIndex})">
                        <i class="fas fa-trash-alt"></i> Hapus
                    </button>`;
            });
        }


        // =================================================================
        // A. FITUR UPLOAD & PREVIEW
        // =================================================================
        
        function handleSiswaChange() {
            const siswaSelect = document.getElementById('siswaSelect');
            const selectedOption = siswaSelect.options[siswaSelect.selectedIndex];
            const folderIdDisplay = document.getElementById('folderIdDisplay');
            const fileType = document.querySelector('input[name="fileTypeRadio"]:checked').value;

            currentFolderId = selectedOption.getAttribute('data-folder-id');
            currentSiswaName = selectedOption.value;

            if (currentFolderId) {
                folderIdDisplay.textContent = `Folder ID: ${currentFolderId}`;
                getPreview(currentFolderId, fileType, currentSiswaName);
            } else {
                folderIdDisplay.textContent = '';
                showMessage('warning', 'Mohon pilih siswa terlebih dahulu.', 'previewMessageArea');
                document.getElementById('previewFrame').src = "";
                document.getElementById('downloadPrintBtn').style.display = 'none';
            }
        }
        
        async function getPreview(folderId, fileType, siswaName) {
            const previewFrame = document.getElementById('previewFrame');
            const downloadPrintBtn = document.getElementById('downloadPrintBtn');
            downloadPrintBtn.style.display = 'none';
            
            showMessage('info', `<i class="fas fa-search me-1"></i> Mencari file ${fileType} untuk ${siswaName}...`, 'previewMessageArea');
            previewFrame.src = ""; 

            const url = `${APPS_SCRIPT_URL}?action=getPreviewLink&folderId=${folderId}&fileType=${fileType}`;
            const result = await fetchData(url);

            if (result.success) {
                previewFrame.src = result.previewLink;
                downloadPrintBtn.href = result.downloadLink;
                downloadPrintBtn.style.display = 'block';
                showMessage('success', `<i class="fas fa-check-circle me-1"></i> Pratinjau file ${fileType} terbaru ditemukan.`, 'previewMessageArea');
            } else {
                showMessage('info', `<i class="fas fa-exclamation-triangle me-1"></i> ${result.message}`, 'previewMessageArea');
                previewFrame.src = "";
            }
        }
        
        async function uploadFile() {
            if (isLoading) return;

            const fileInput = document.getElementById('fileInput').files[0];
            const fileType = document.querySelector('input[name="fileTypeRadio"]:checked').value;
            const folderId = currentFolderId;
            const siswaName = currentSiswaName;

            if (!folderId || folderId === "") {
                showMessage('danger', 'ERROR: Mohon pilih siswa terlebih dahulu.');
                return;
            }
            if (!fileInput) {
                showMessage('danger', 'ERROR: Mohon pilih file PDF yang akan diunggah.');
                return;
            }

            setLoading(true, 'uploadBtn', 'uploadSpinner', 'Upload');
            showMessage('info', `<i class="fas fa-upload me-1"></i> Mengunggah file ${fileType} untuk ${siswaName}... Ini mungkin memakan waktu beberapa detik.`, 'uploadMessageArea');

            try {
                const formData = new FormData();
                formData.append('action', 'uploadFile');
                formData.append('folderId', folderId);
                formData.append('fileType', fileType);
                formData.append('siswaName', siswaName);
                formData.append('file', fileInput); 

                const options = {
                    method: 'POST',
                    body: formData,
                };

                const result = await fetchData(APPS_SCRIPT_URL, options);
                
                if (result.success) {
                    showMessage('success', result.message, 'uploadMessageArea');
                    getPreview(folderId, fileType, siswaName); // Muat ulang pratinjau
                    document.getElementById('fileInput').value = ''; // Reset input file
                } else {
                    showMessage('danger', result.message || 'Upload gagal karena error server yang tidak diketahui.', 'uploadMessageArea');
                }
            } catch (error) {
                showMessage('danger', `Kesalahan Jaringan/Aplikasi: ${error.message}`, 'uploadMessageArea');
            } finally {
                setLoading(false, 'uploadBtn', 'uploadSpinner', 'Upload');
            }
        }

        // =================================================================
        // B. FITUR TAMBAH SISWA (CRUD)
        // =================================================================

        async function tambahSiswa() {
            const newNis = document.getElementById('newNis').value.trim();
            const newName = document.getElementById('newName').value.trim();
            
            if (!newNis || !newName) {
                showMessage('danger', 'NIS dan Nama harus diisi.', 'modalMessageArea');
                return;
            }
            
            setLoading(true, 'saveSiswaBtn', 'addSpinner', 'Simpan Siswa');
            showMessage('info', 'Memproses data siswa baru...', 'modalMessageArea');

            try {
                const formData = new FormData();
                formData.append('action', 'tambahSiswa');
                formData.append('nis', newNis);
                formData.append('name', newName);

                const options = { method: 'POST', body: formData };
                const result = await fetchData(APPS_SCRIPT_URL, options);

                if (result.success) {
                    // Update data lokal dan UI
                    siswaData.push(result.data);
                    renderSiswaDropdown();
                    renderSiswaTable();
                    
                    showMessage('success', result.message, 'modalMessageArea');
                    // Reset form modal
                    document.getElementById('newNis').value = '';
                    document.getElementById('newName').value = '';
                    // Tutup modal setelah 2 detik
                    setTimeout(() => bootstrap.Modal.getInstance(document.getElementById('addSiswaModal')).hide(), 2000);
                    
                } else {
                    showMessage('danger', result.message, 'modalMessageArea');
                }
            } catch (error) {
                 showMessage('danger', `Kesalahan: ${error.message}`, 'modalMessageArea');
            } finally {
                setLoading(false, 'saveSiswaBtn', 'addSpinner', 'Simpan Siswa');
            }
        }
        
        // =================================================================
        // C. FITUR HAPUS SISWA (CRUD)
        // =================================================================

        function confirmHapusSiswa(siswaName, rowIndex) {
             if (confirm(`Apakah Anda yakin ingin MENGHAPUS data siswa "${siswaName}" (Baris ${rowIndex}) dari Google Sheet? File Drive tidak akan terhapus.`)) {
                hapusSiswa(rowIndex);
            }
        }

        async function hapusSiswa(rowIndex) {
            // Nonaktifkan tombol hapus untuk baris yang dipilih saat proses
            document.querySelector(`[data-row-index="${rowIndex}"] button`).disabled = true;

            try {
                const formData = new FormData();
                formData.append('action', 'hapusSiswa');
                formData.append('rowIndex', rowIndex);

                const options = { method: 'POST', body: formData };
                const result = await fetchData(APPS_SCRIPT_URL, options);

                if (result.success) {
                    showMessage('success', result.message, 'previewMessageArea');
                    // Muat ulang daftar untuk memastikan index baris di Sheet sinkron (wajib setelah hapus baris)
                    await loadSiswaList();
                } else {
                    showMessage('danger', result.message, 'previewMessageArea');
                }
            } catch (error) {
                showMessage('danger', `Kesalahan: ${error.message}`, 'previewMessageArea');
            }
            // Tombol akan diaktifkan kembali jika loadSiswaList() gagal atau di dalam proses,
            // tetapi cara paling aman adalah memuat ulang daftar.
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>