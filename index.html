<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            max-width: 900px;
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        #previewFrame {
            width: 100%;
            height: 600px;
            border: 1px solid #dee2e6;
            margin-top: 20px;
            border-radius: 4px;
        }

        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <h3 class="mb-4 text-center text-primary">Pusat Data Ledger & Rapor Siswa</h3>

        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <label for="siswaSelect" class="form-label">Pilih Siswa:</label>
                <select class="form-select" id="siswaSelect" onchange="handleSiswaChange()">
                    <option value="" data-folder-id="">--- Pilih Siswa ---</option>
                </select>
                <small id="folderIdDisplay" class="form-text text-muted"></small>
            </div>
            <div class="col-md-6">
                <label class="form-label">Pilih Tipe File:</label>
                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="fileTypeRadio" id="radioLedger" value="LEDGER" checked onchange="handleSiswaChange()">
                        <label class="form-check-label" for="radioLedger">LEDGER</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="fileTypeRadio" id="radioRapor" value="RAPOR" onchange="handleSiswaChange()">
                        <label class="form-check-label" for="radioRapor">RAPOR</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="card p-3 mb-4 border-success">
            <h5 class="card-title text-success">Upload File PDF</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-8">
                    <label for="fileInput" class="form-label">Pilih File PDF Ledger/Rapor:</label>
                    <input class="form-control" type="file" id="fileInput" accept=".pdf" required>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-success w-100" id="uploadBtn" onclick="uploadFile()">
                        <span id="uploadSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                        Upload
                    </button>
                </div>
            </div>
        </div>

        <div id="messageArea" class="mb-3"></div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="m-0">Pratinjau File Terbaru</h5>
            <a href="#" id="downloadPrintBtn" class="btn btn-outline-secondary btn-sm" style="display: none;" target="_blank">
                Download/Print File
            </a>
        </div>

        <iframe id="previewFrame" title="Pratinjau File"></iframe>

    </div>

    <script>
        // ðŸ”´ PENTING: GANTI DENGAN URL WEB APP APPS SCRIPT ANDA YANG SUDAH DIOTORISASI (berakhir /exec)
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyty1QfpmeJvfd_39RjybFng1SHStoPbckz8n2Wvp_z4E3rc5e1N_ubfAPV04c2t6MFag/exec"; 
        
        let currentFolderId = null;
        let currentSiswaName = null;
        let currentDownloadLink = "";
        let isLoading = false; // Flag untuk mencegah double-click

        document.addEventListener('DOMContentLoaded', loadSiswaList);

        /**
         * Fungsi utilitas untuk fetch data dari Apps Script.
         * @param {string} url - URL Apps Script.
         * @param {Object} options - Opsi fetch (method, body, dll.).
         */
        async function fetchData(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Fetch Error:', error);
                return {
                    success: false,
                    message: `Koneksi gagal: ${error.message}`
                };
            }
        }

        /**
         * Memuat daftar siswa ke dalam dropdown.
         */
        async function loadSiswaList() {
            const siswaSelect = document.getElementById('siswaSelect');
            siswaSelect.innerHTML = '<option value="" data-folder-id="">--- Memuat Data Siswa... ---</option>';
            
            const url = `${APPS_SCRIPT_URL}?action=getSiswaList`;
            const result = await fetchData(url);

            if (result.success && Array.isArray(result.data)) {
                siswaSelect.innerHTML = '<option value="" data-folder-id="">--- Pilih Siswa ---</option>';
                result.data.forEach(siswa => {
                    const option = document.createElement('option');
                    option.value = siswa.name;
                    option.textContent = `${siswa.name} (NIS: ${siswa.nis})`;
                    option.setAttribute('data-folder-id', siswa.folderId);
                    siswaSelect.appendChild(option);
                });
            } else {
                siswaSelect.innerHTML = `<option value="" disabled>${result.message || 'Gagal memuat data siswa.'}</option>`;
                showMessage('danger', result.message || 'Gagal memuat data siswa. Cek Sheet ID dan koneksi Anda.');
            }
        }

        /**
         * Menangani perubahan pilihan siswa atau tipe file.
         */
        function handleSiswaChange() {
            const siswaSelect = document.getElementById('siswaSelect');
            const selectedOption = siswaSelect.options[siswaSelect.selectedIndex];
            const folderIdDisplay = document.getElementById('folderIdDisplay');
            const fileType = document.querySelector('input[name="fileTypeRadio"]:checked').value;

            currentFolderId = selectedOption.getAttribute('data-folder-id');
            currentSiswaName = selectedOption.value;

            // Tampilkan Folder ID (opsional untuk debugging)
            if (currentFolderId) {
                folderIdDisplay.textContent = `Folder ID: ${currentFolderId}`;
                getPreview(currentFolderId, fileType);
            } else {
                folderIdDisplay.textContent = '';
                showMessage('warning', 'Mohon pilih siswa terlebih dahulu.');
                document.getElementById('previewFrame').src = "";
                document.getElementById('downloadPrintBtn').style.display = 'none';
            }
        }


        /**
         * Menampilkan pratinjau file PDF terbaru.
         * @param {string} folderId - ID Folder Siswa.
         * @param {string} fileType - Tipe file (LEDGER/RAPOR).
         */
        async function getPreview(folderId, fileType) {
            const previewFrame = document.getElementById('previewFrame');
            const downloadPrintBtn = document.getElementById('downloadPrintBtn');
            downloadPrintBtn.style.display = 'none';
            
            if (!folderId || folderId === "") {
                showMessage('warning', 'Mohon pilih siswa terlebih dahulu.');
                previewFrame.src = "";
                return;
            }
            
            showMessage('info', 'Mencari file PDF terbaru...');
            previewFrame.src = ""; 

            const url = `${APPS_SCRIPT_URL}?action=getPreviewLink&folderId=${folderId}&fileType=${fileType}`;
            const result = await fetchData(url);

            if (result.success) {
                // Tampilkan link preview
                previewFrame.src = result.previewLink;
                // Set link download/print
                currentDownloadLink = result.downloadLink; 
                downloadPrintBtn.href = currentDownloadLink;
                downloadPrintBtn.style.display = 'block';
                showMessage('success', `Pratinjau file ${fileType} ditemukan.`);
            } else {
                showMessage('info', result.message);
                previewFrame.src = "";
            }
        }


        /**
         * Menangani proses upload file.
         */
        async function uploadFile() {
            if (isLoading) return;

            const siswaSelect = document.getElementById('siswaSelect');
            const fileInput = document.getElementById('fileInput').files[0];
            const fileType = document.querySelector('input[name="fileTypeRadio"]:checked').value;
            const folderId = currentFolderId;
            const siswaName = currentSiswaName;

            // ðŸ›‘ VALIDASI KLIEN-SIDE EKSPLISIT UNTUK MENCEGAH ERROR
            if (!folderId || folderId === "") {
                showMessage('danger', 'ERROR: Mohon pilih siswa terlebih dahulu.');
                return;
            }
            if (!fileInput) {
                showMessage('danger', 'ERROR: Mohon pilih file PDF yang akan diunggah.');
                return;
            }

            // Ubah UI menjadi loading
            setLoading(true);
            showMessage('info', `Mengunggah file ${fileType} untuk ${siswaName}... Ini mungkin memakan waktu beberapa detik.`);

            try {
                // Siapkan FormData
                const formData = new FormData();
                formData.append('action', 'uploadFile');
                formData.append('folderId', folderId);
                formData.append('fileType', fileType);
                formData.append('siswaName', siswaName);
                formData.append('file', fileInput); // Mengirim objek File (Blob)

                const options = {
                    method: 'POST',
                    body: formData,
                };

                const result = await fetchData(APPS_SCRIPT_URL, options);
                
                if (result.success) {
                    showMessage('success', result.message);
                    // Setelah sukses, tampilkan pratinjau file yang baru diupload
                    getPreview(folderId, fileType);
                } else {
                    showMessage('danger', result.message || 'Upload gagal karena error server yang tidak diketahui.');
                }
            } catch (error) {
                showMessage('danger', `Kesalahan Jaringan/Aplikasi: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        /**
         * Mengubah status loading pada tombol dan flag.
         * @param {boolean} loading - Status loading.
         */
        function setLoading(loading) {
            isLoading = loading;
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadSpinner = document.getElementById('uploadSpinner');
            uploadBtn.disabled = loading;
            uploadSpinner.classList.toggle('d-none', !loading);
            uploadBtn.textContent = loading ? 'Uploading...' : 'Upload';
            if (!loading) uploadBtn.prepend(uploadSpinner); // Pindahkan spinner kembali saat selesai
        }

        /**
         * Menampilkan pesan notifikasi.
         * @param {string} type - Tipe alert (success, danger, info, warning).
         * @param {string} message - Isi pesan.
         */
        function showMessage(type, message) {
            const messageDiv = document.getElementById('messageArea');
            messageDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>